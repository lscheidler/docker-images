# Copyright 2022 Lars Eric Scheidler
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- hosts: localhost
  connection: local
  tasks:
    - name: include variables
      include_vars: vars.yml
    - name: "pre"
      include_tasks: "tasks/{{ backend | default('docker') }}-pre.yml"
    - name: "generate chroot cache in {{ debootstrap_directory }}"
      command: "{{ debootstrap_command | default('debootstrap') }} --variant=minbase --include={{ [ included_packages['common'] | join(','), included_packages[distribution] | default([]) | join(',')] | join(',') }} {{ distribution }} {{ debootstrap_directory }}"
      args: 
        creates: "{{ debootstrap_directory }}/bin"
      register: debootstrap
    - add_host:
        hostname: '{{ chroot_hostname }}'
        ansible_connection: '{{ ansible_chroot_backend }}'
        groups:
          - chroots

- hosts: chroots
  tasks:
    - include_tasks: tasks/chroot.yml

- hosts: localhost
  connection: local
  tasks:
    - block:
        - set_fact:
            timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
            src_name: "{{ type }}-{{ distribution }}"
    - name: include variables
      include_vars: vars.yml
    - name: register chroot_host
      set_fact:
        chroot_host: '{{ hostvars[chroot_hostname] }}'
    - block:
        - include_tasks: "tasks/{{ backend | default('docker') }}-post.yml"
      when: debootstrap is changed or chroot_host.chroot_update is changed or force | default('no') | bool
